<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orden de Trabajo - Fueltek</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- CSS INTEGRADO -->
  <style>
    :root{
      --primary: #004d99; /* Azul Corporativo */
      --accent: #f26522; /* Naranja Contraste */
      --dark: #2c3e50; /* Gris Oscuro/Negro Sobrio */
      --border: #e0e0e0;
      --bg: #f4f7f9; /* Fondo muy claro */
      --card: #fff;
      --success: #27ae60; /* Verde para Guardar */
      --danger: #c0392b; /* Rojo para Borrar */
    }

    *{box-sizing:border-box}
    body{
      font-family: 'Inter', "Segoe UI", Roboto, Arial, sans-serif; /* Fuente moderna */
      margin:0;
      background:var(--bg);
      color:var(--dark);
    }

    .wrapper{
      max-width:1020px;
      margin:25px auto;
      background:var(--card);
      border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,0.1);
      overflow:hidden;
    }

    /* --- HEADER MÁS MODERNO Y LIMPIO --- */
    header{
      display:flex;
      gap:16px;
      align-items:center;
      background:var(--dark);
      color:white;
      padding:18px;
      border-bottom: 3px solid var(--primary); /* Nuevo separador */
    }
    .logo{width:80px;height:80px;object-fit:contain;border-radius:8px;}
    .header-info h1{font-size:1.8rem;margin:0}
    .header-info p{font-size:1rem;margin:0}
    .header-info small{font-size:0.75rem;opacity:0.8}

    /* --- MAIN & FORM LAYOUT --- */
    main{padding:25px}

    .ot-bar{
        display:flex;
        justify-content:space-between;
        align-items:center;
        background:white;
        padding:15px;
        border-radius:8px;
        box-shadow:0 2px 8px rgba(0,0,0,0.05);
        margin-bottom:20px;
        gap:10px;
    }
    .ot-bar .left{display:flex;align-items:center;gap:10px;font-size:1.1rem;font-weight:700}
    .ot-label{color:var(--primary)}
    #otNumber{
        font-size:1.4rem;
        font-weight:800;
        color:var(--accent);
        background:transparent;
        border:none;
        width:80px;
    }

    .ot-bar .right{
        display:flex;
        gap:10px;
    }

    .session-info {
        text-align: right;
        margin-bottom: 15px;
    }
    .session-info small {
        color: var(--dark);
        opacity: 0.7;
    }

    /* --- FORM STYLES --- */
    #otForm{display:flex;flex-direction:column;gap:20px}
    fieldset{
        border:1px solid var(--border);
        border-radius:8px;
        padding:20px;
        margin:0;
    }
    legend{
        font-size:1.2rem;
        font-weight:700;
        color:var(--primary);
        padding:0 10px;
    }
    label{
        display:flex;
        flex-direction:column;
        font-size:0.9rem;
        font-weight:600;
        color:var(--dark);
        gap:5px;
    }
    input:not([type="checkbox"]), textarea{
        padding:10px;
        border:1px solid var(--border);
        border-radius:6px;
        font-size:1rem;
        width:100%;
        transition:border-color 0.2s;
        background:var(--bg);
    }
    input:focus, textarea:focus{border-color:var(--primary);outline:none;background:white}

    .grid-2-col{
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:15px;
    }

    /* --- ITEM LIST STYLES --- */
    #itemsContainer{
        display:flex;
        flex-direction:column;
        gap:10px;
        margin-bottom:15px;
    }
    .item-row{
        display:grid;
        grid-template-columns:minmax(150px, 4fr) 80px 1.5fr 1.5fr auto;
        gap:10px;
        align-items:center;
        padding:8px 0;
        border-bottom:1px dashed var(--border);
    }
    .item-row input{padding:8px;font-size:0.95rem;background:white}
    .item-row .desc-input{grid-column:1 / 2}
    .item-row .qty-input{text-align:center}
    .item-row .price-input{text-align:right}
    .item-row .total-item{
        font-weight:700;
        text-align:right;
        color:var(--dark);
        font-size:1rem;
    }
    .item-row .delete-item-btn{
        background:none;
        border:none;
        color:var(--danger);
        cursor:pointer;
        padding:0;
        width:30px;
        height:30px;
        display:flex;
        align-items:center;
        justify-content:center;
        transition:transform 0.2s;
    }
    .item-row .delete-item-btn:hover{transform:scale(1.1)}
    .item-row .delete-item-btn i{width:18px;height:18px}


    .total-bar{
        display:flex;
        justify-content:flex-end;
        flex-direction:column;
        gap:10px;
        margin-top:20px;
        align-items:flex-end;
    }
    .total-bar label{
        flex-direction:row;
        gap:15px;
        font-size:1.1rem;
        font-weight: bold;
        color:var(--dark);
        width: 300px; /* Ancho fijo para alineación */
        justify-content: space-between;
    }
    .total-bar input[readonly]{
        background:var(--bg);
        border:1px solid var(--border);
        font-weight:700;
        text-align:right;
        color:var(--primary);
    }
    #totalInput{
        color:var(--accent);
        font-size:1.2rem;
    }
    .abono-bar {
        display: flex;
        justify-content: flex-end;
        margin-top: 10px;
    }
    .abono-bar label {
        flex-direction: row;
        gap: 15px;
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--dark);
        width: 300px;
        justify-content: space-between;
    }
    #montoAbonadoInput {
        text-align: right;
        font-weight: 600;
    }

    /* --- FIRMAS & NOTAS --- */
    .firmas{
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:40px;
        padding-top:20px;
        border-top:1px dashed var(--border);
        margin-top:20px;
    }
    .firma-box label{text-align:center;font-size:1rem}
    .firma-box input{border:none;border-bottom:2px solid var(--dark);border-radius:0;text-align:center}

    .notas{
        padding:15px;
        background:var(--bg);
        border-radius:8px;
        margin-top:20px;
    }
    .notas h4{margin-top:0;color:var(--accent)}
    .notas ul{list-style:none;padding:0;font-size:0.9rem;line-height:1.6}
    .notas li::before{content:"•";color:var(--primary);font-weight:bold;display:inline-block;width:1em;margin-left:-1em}

    /* --- BUTTONS --- */
    button{
        padding:10px 15px;
        border-radius:8px;
        border:none;
        cursor:pointer;
        font-size:1rem;
        font-weight:600;
        transition:background 0.2s, transform 0.1s;
        display:flex;
        align-items:center;
        gap:6px;
        justify-content:center;
    }
    button:active{transform:scale(0.98)}
    button.primary{background:var(--primary);color:white}
    button.primary:hover{background:#003a7a}
    button.accent{background:var(--accent);color:white}
    button.accent:hover{background:#d85a18}
    button.success{background:var(--success);color:white}
    button.success:hover{background:#1f8e4c}
    button.danger{background:var(--danger);color:white}
    button.danger:hover{background:#a13023}
    button.small{padding:6px 10px;font-size:0.85rem}

    /* --- MESSAGE BOX --- */
    .message-box {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-weight: 600;
        transition: opacity 0.3s;
    }
    .message-box.hidden {
        display: none;
    }
    .message-box.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .message-box.danger {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .message-box.primary {
        background-color: #cce5ff;
        color: #004085;
        border: 1px solid #b8daff;
    }


    /* --- MODAL STYLES --- */
    .modal{
        position:fixed;
        top:0;left:0;
        width:100%;height:100%;
        background:rgba(0,0,0,0.6);
        display:flex;
        justify-content:center;
        align-items:center;
        z-index:1000;
        opacity:1; /* Asegura que la capa es visible por defecto si no tiene la clase hidden */
        transition:opacity 0.3s;
    }
    .modal.hidden{
        opacity:0;
        pointer-events:none;
    }
    .modal-content{
        background:white;
        padding:25px;
        border-radius:12px;
        width:90%;
        max-width:600px;
        box-shadow:0 5px 20px rgba(0,0,0,0.2);
        max-height:80vh;
        display:flex;
        flex-direction:column;
    }
    .modal-header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:15px;
        padding-bottom:10px;
        border-bottom:1px solid var(--border);
    }
    .modal-header h3{margin:0;color:var(--primary)}
    .modal-body{
        overflow-y:auto;
        flex-grow:1;
        padding-right:5px;
    }
    #searchOt{margin-bottom:15px;padding:10px;border-radius:6px;width:100%;}

    .orders-list{display:flex;flex-direction:column;gap:10px}
    .order-row{
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:12px;
        border-bottom:1px solid #e5e5e5;
        background:var(--bg);
        border-radius:8px;
        margin-bottom:8px;
        box-shadow:0 1px 4px rgba(0,0,0,0.08)
    }
    .order-info{
        display:flex;
        flex-direction:column;
    }
    .order-info b{color:var(--primary);font-size:1.1rem}
    .order-info small{color:var(--dark);opacity:0.7;font-size:0.8rem}
    .order-actions{display:flex;gap:8px}


    /* --- FOOTER --- */
    footer{background:var(--dark);color:white;padding:15px;text-align:center;font-size:0.85rem}

    /* --- RESPONSIVENESS & PRINT STYLES --- */
    .mobile-only{display:none}
    @media (max-width: 768px) {
        .wrapper{margin:0}
        .grid-2-col{grid-template-columns:1fr}
        .ot-bar{flex-direction:column;align-items:flex-start}
        .ot-bar .left{width:100%;margin-bottom:10px}
        .ot-bar .right{
            flex-direction:column;
            width:100%;
            gap:5px;
            display:none; /* Oculto por defecto, se muestra con el menú móvil */
            transition:max-height 0.3s ease-out;
            max-height:0;
            overflow:hidden;
        }
        .ot-bar .right.mobile-visible{
            display:flex;
            max-height:500px; /* Suficiente altura para mostrar todos los botones */
        }
        .ot-bar .right button{width:100%}
        .mobile-only{display:block}
        .desktop-only{display:none}

        .item-row{
            grid-template-columns:1fr;
            gap:5px;
            padding:10px;
            border:1px solid var(--border);
            border-radius:6px;
            position: relative; /* Para posicionar el botón de eliminar */
        }
        .item-row .desc-input{grid-column:1 / -1}
        .item-row .qty-input, .item-row .price-input, .item-row .total-item{
            width:100%;
            text-align:left;
        }
        .item-row .delete-item-btn{position:absolute;top:5px;right:5px}
        .firmas{grid-template-columns:1fr;gap:20px}
        .total-bar label, .abono-bar label {
            width: 100%;
        }
    }

    /* --- PRINT STYLES --- */
    @page{size:letter;margin:10mm} 

    @media print{
        body{background:white;font-size:10pt}
        .wrapper, .modal, .session-info, .ot-bar button, .ot-bar .right, #mobileMenuBtn, footer, .message-box {
            display:none !important;
        }
        .print-area{
            display:block !important;
            max-width:1000px;
            margin:0 auto;
            padding:0;
        }
        .print-area header{
            background:transparent;
            color:var(--dark);
            border-bottom: 2px solid var(--primary);
            padding:0;
        }
        .print-area .header-info h1{font-size:1.5rem}
        .print-area .header-info p{font-size:0.9rem}
        .print-area .header-info small{font-size:0.7rem;opacity:1}
        .print-area main{padding:10px 0}
        
        .print-area .ot-bar{
            background:none;
            box-shadow:none;
            margin-bottom:10px;
            padding:0;
            display: flex; /* Asegura que se muestre en impresión */
            justify-content: space-between;
        }
        .print-area .ot-bar .left span{
            font-size:1.2rem;
            font-weight:800;
            color:var(--accent);
        }

        .print-area fieldset{
            border:1px solid #ccc;
            border-radius:0;
            padding:10px;
            page-break-inside:avoid;
        }
        .print-area legend{
            font-size:1.1rem;
            color:var(--primary);
        }
        .print-area label{
            display: flex;
            flex-direction:row;
            gap:5px;
            font-weight:600;
        }
        .print-area label span, .print-area label p {
            font-weight:400;
            flex-grow:1;
            text-align:right;
        }
        .print-area label p {
            text-align:left;
            text-align:justify; /* Justificar el texto largo */
        }
        
        .print-items-table table{width:100%;border-collapse:collapse;margin-bottom:10px}
        .print-items-table th, .print-items-table td{border:1px solid #ddd;padding:5px;text-align:left;font-size:0.85rem}
        .print-items-table th{background:#eee;font-weight:700}
        .print-items-table .right{text-align:right}

        .print-area .total-bar, .print-area .abono-bar {
            display: flex; /* Asegura que se muestre en impresión */
            justify-content: flex-end;
            align-items: flex-end;
            margin-top: 5px;
        }
        .print-area .total-bar label, .print-area .abono-bar label {
            width: 300px;
            font-size: 1rem;
            border-bottom: 1px dashed #ccc;
            padding: 3px 0;
            justify-content: space-between;
        }
        .print-area #totalInput, .print-area .total-bar label:last-child span{
            font-size:1.1rem;
            color:var(--accent);
            font-weight:800;
        }

        .print-area .firmas{
            padding-top:10px;
            border-top:1px solid #ccc;
            margin-top:15px;
            display: grid; /* Asegura que se muestre en impresión */
        }
        .print-area .firma-box{
            display:flex;
            flex-direction:column;
            align-items:center;
        }
        .print-area .firma-box label{font-size:0.9rem;font-weight:600}
        .print-area .firma-box .signature-line{
            display:block;
            width:100%;
            height:1px;
            background:var(--dark);
            margin-top:30px;
        }

        .print-area .notas{
            background:#f0f0f0;
            padding:10px;
            margin-top:15px;
        }
        .print-area .notas h4{font-size:1rem}
        .print-area .notas li{font-size:0.8rem}
    }
  </style>

</head>
<body>
  <div class="wrapper">
    <header>
      <!-- Logo Fueltek como placeholder -->
      <img src="https://placehold.co/80x80/2c3e50/ffffff?text=FT" alt="Fueltek Logo" class="logo" />
      <div class="header-info">
        <h1>FUELTEK</h1>
        <p>Servicio Técnico Multimarca</p>
        <small>Tel: +56 9 4043 5805 | La Trilla 1062, San Bernardo</small>
      </div>
    </header>

    <main>
      <div class="ot-bar">
        <div class="left">
          <label class="ot-label">N° OT:</label>
          <input id="otNumber" readonly value="0001" /> 
        </div>

        <button id="mobileMenuBtn" class="mobile-only" title="Menú"><i data-lucide="menu"></i></button>

        <div class="right desktop-only">
          <button id="newOtBtn"><i data-lucide="plus"></i> Nueva OT</button>
          <button id="saveOtBtn" class="success"><i data-lucide="save"></i> Guardar</button>
          <button id="printOtBtn" class="accent"><i data-lucide="printer"></i> Imprimir</button>
          <button id="openModalBtn" class="primary"><i data-lucide="folder"></i> Ver Órdenes</button>
          <button id="exportExcelBtn" class="primary"><i data-lucide="file-spreadsheet"></i> Exportar Excel</button>
        </div>
      </div>
      
      <!-- Contenedor para mensajes de estado/error -->
      <div id="messageBox" class="message-box hidden" role="alert"></div>

      <!-- Información de la sesión Firebase -->
      <div class="session-info">
        <small id="authStatus">Conectando...</small>
      </div>

      <form id="otForm">
        <fieldset class="grid-2-col">
          <legend>Datos del Cliente</legend>
          <label>Nombre Cliente: <input name="nombreCliente" required /></label>
          <label>Rut/ID: <input name="rutId" /></label>
          <label>Teléfono: <input name="telefono" type="tel" /></label>
          <label>Email: <input name="email" type="email" /></label>
        </fieldset>

        <fieldset class="grid-2-col">
          <legend>Datos del Equipo</legend>
          <label>Tipo Equipo: <input name="tipoEquipo" /></label>
          <label>Marca/Modelo: <input name="marcaModelo" /></label>
          <label>Año: <input name="año" type="number" inputmode="numeric" /></label>
          <label>N° Serie/VIN: <input name="nroSerie" /></label>
        </fieldset>

        <fieldset>
          <legend>Problema Reportado / Trabajos a Realizar</legend>
          <label>Descripción: <textarea name="problemaReportado" rows="4" required></textarea></label>
        </fieldset>

        <fieldset>
          <legend>Detalle de Repuestos, Servicios y Valores</legend>
          <div id="itemsContainer">
            <!-- Los items se agregarán aquí por JavaScript -->
          </div>
          <button type="button" id="addItemBtn" class="primary small"><i data-lucide="plus"></i> Agregar Item</button>

          <div class="total-bar">
            <label>Subtotal: <input name="subtotal" type="text" inputmode="numeric" id="subtotalInput" readonly value="$0" /></label>
            <label>IVA (19%): <input name="iva" type="text" inputmode="numeric" id="ivaInput" readonly value="$0" /></label>
            <label>TOTAL: <input name="total" type="text" inputmode="numeric" id="totalInput" readonly value="$0" /></label>
          </div>

          <div class="abono-bar">
            <label>Monto Abonado: <input name="montoAbonado" type="text" inputmode="numeric" id="montoAbonadoInput" value="$0" /></label>
          </div>
        </fieldset>

        <div class="firmas">
          <div class="firma-box"><label>Firma Taller</label><input name="firmaTaller" /></div>
          <div class="firma-box"><label>Firma Cliente</label><input name="firmaCliente" /></div>
        </div>

        <section class="notas">
          <h4>Notas importantes</h4>
          <ul>
            <li>Toda herramienta no retirada en 30 días podrá generar cobro por almacenamiento.</li>
            <li>FuelTek no se responsabiliza por accesorios no declarados al momento de la recepción.</li>
            <li>El cliente declara estar informado sobre los términos del servicio y autoriza la revisión del equipo.</li>
          </ul>
        </section>
      </form>
    </main>

    <footer>
      <p>© 2025 FUELTEK</p>
    </footer>
  </div>

  <div id="modal" class="modal hidden" role="dialog" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Órdenes guardadas</h3>
        <button id="closeModal" class="small">Cerrar</button>
      </div>
      <div class="modal-body">
        <input id="searchOt" placeholder="Buscar por N° OT o nombre cliente..." />
        <div id="ordersList" class="orders-list"></div>
        <p class="mt-4"><small id="modal-footer-info">Cargando datos...</small></p>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmación para la función de Eliminar -->
    <div id="modalConfirm" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="confirmMessage">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirmación Requerida</h3>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="confirmNo" class="primary small">Cancelar</button>
                <button id="confirmYes" class="danger small">Confirmar</button>
            </div>
        </div>
    </div>
  <!-- Fin Modal de Confirmación -->

  <div id="printArea" class="print-area" style="display:none"></div>

  <!-- LÓGICA DE FIRESTORE Y JS INTEGRADA -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, setDoc, deleteDoc, query, onSnapshot, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Configuraciones inyectadas por el entorno
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db;
    let auth;
    let userId = null;
    let workOrders = []; 
    let currentOtId = null; 
    let isAuthReady = false;

    // ====================================================================\
    // FIREBASE INITIALIZATION & AUTH
    // ====================================================================\

    function initializeFirebase() {
        if (Object.keys(firebaseConfig).length > 0) {
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } else {
            console.error("Firebase config is missing.");
            document.getElementById('authStatus').textContent = "ERROR: Configuración Firebase Faltante.";
            return;
        }

        onAuthStateChanged(auth, async (user) => {
            const authStatusElement = document.getElementById('authStatus');
            
            if (user) {
                userId = user.uid;
                authStatusElement.textContent = `ID Sesión: ${userId.substring(0, 8)}... (Autenticado)`;
                isAuthReady = true;
                initializeAppLogic();
            } else {
                try {
                    // Intento de inicio de sesión anónimo si no hay usuario
                    await signInAnonymously(auth);
                    // onAuthStateChanged se disparará de nuevo con el usuario anónimo
                } catch (error) {
                    console.error("Error en autenticación anónima:", error);
                    authStatusElement.textContent = "ERROR de autenticación";
                    isAuthReady = true;
                    // Continuar con la lógica de UI aunque la DB falle (para que al menos funcione el form)
                    initializeAppLogic(); 
                }
            }
        });

        // Intento de inicio de sesión con token personalizado (si está disponible)
        if (initialAuthToken) {
             signInWithCustomToken(auth, initialAuthToken).catch((error) => {
                console.error("Error al iniciar sesión con Custom Token:", error);
             });
        } else if (!auth.currentUser) {
            // Si no hay token y no hay usuario, forzar el intento anónimo
            signInAnonymously(auth).catch(e => console.error("Error anónimo inicial:", e));
        }
    }


    // ====================================================================\
    // UTILITIES (CLP FORMAT & UI MESSAGES)
    // ====================================================================\

    function formatCLP(num) {
      if (num === null || num === undefined) return "0";
      const n = String(num).replace(/[^\d]/g, '');
      if (n === "") return "";
      // Asegurar que el resultado de Intl.NumberFormat es correcto
      return new Intl.NumberFormat('es-CL').format(Number(n));
    }

    function unformatCLP(str) {
      if (str === null || str === undefined) return 0;
      // Permite números con formato CLP (puntos de miles)
      const cleaned = String(str).replace(/[^\d]/g, ''); 
      return parseInt(cleaned, 10) || 0;
    }

    function handleFormatOnInput(e) {
      const input = e.target;
      const numericValue = unformatCLP(input.value);
      input.value = formatCLP(numericValue);
    }

    function showMessage(message, type = 'success', duration = 4000) {
        const messageBox = document.getElementById('messageBox');
        messageBox.textContent = message;
        messageBox.className = `message-box ${type}`;
        messageBox.classList.remove('hidden');

        if (duration > 0) {
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, duration);
        }
    }

    // ====================================================================\
    // FIREBASE FIRESTORE LOGIC
    // ====================================================================\

    function getOrdersCollectionRef() {
        if (!userId || !db) return null;
        // Ruta: /artifacts/{appId}/users/{userId}/work_orders
        const path = `artifacts/${appId}/users/${userId}/work_orders`;
        return collection(db, path);
    }

    function setupFirestoreListener() {
        if (!isAuthReady || !userId || !db) {
            console.warn("Firestore listener no se puede iniciar: Autenticación no completada.");
            document.getElementById('modal-footer-info').textContent = "Esperando conexión de base de datos...";
            return;
        }

        const ordersCollectionRef = getOrdersCollectionRef();
        if (!ordersCollectionRef) return;
        
        const q = query(ordersCollectionRef);
        
        onSnapshot(q, (snapshot) => {
            workOrders = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                // El OT ID (número) es el ID del documento
                workOrders.push({
                    ...data,
                    ot: doc.id
                });
            });

            // Ordenar en memoria por el número de OT de forma descendente (el más nuevo primero)
            workOrders.sort((a, b) => unformatCLP(b.ot) - unformatCLP(a.ot));
            
            document.getElementById('modal-footer-info').textContent = `${workOrders.length} órdenes sincronizadas.`;
            
            // Si estamos en una OT nueva o la cargada fue eliminada, actualizar el display
            if (!currentOtId || !workOrders.find(o => o.ot === currentOtId)) {
                newOt();
            }
            
            renderOrdersList(workOrders);
            console.log(`Firestore: ${workOrders.length} órdenes sincronizadas.`);
        }, (error) => {
            console.error("Error al escuchar Firestore:", error);
            showMessage("Error de conexión con la base de datos.", 'danger', 0);
        });
    }

    async function saveOrder(formData) {
        if (!isAuthReady || !userId || !db) {
            showMessage("Error: Sesión no lista para guardar. Inténtalo de nuevo.", 'danger');
            return;
        }

        const otToSave = formData.ot;

        try {
            const docRef = doc(getOrdersCollectionRef(), otToSave);
            await setDoc(docRef, formData);

            showMessage(`Orden de Trabajo N° ${otToSave} guardada exitosamente!`, 'success');
            currentOtId = otToSave;

        } catch (error) {
            console.error("Error al guardar en Firestore:", error);
            showMessage("Error al guardar la orden: " + error.message, 'danger', 8000);
        }
    }

    function loadOrder(otId) {
        const order = workOrders.find(o => o.ot === otId);
        if (!order) {
            showMessage(`Error: Orden N° ${otId} no encontrada.`, 'danger');
            return false;
        }
        
        resetForm(false); 
        currentOtId = otId;
        document.getElementById('otNumber').value = otId;
        
        const form = document.getElementById('otForm');
        Object.keys(order).forEach(key => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input && key !== 'items' && key !== 'ot' && key !== 'montoAbonado') {
                input.value = order[key];
            }
        });

        // Cargar items
        document.getElementById('itemsContainer').innerHTML = '';
        if (order.items && Array.isArray(order.items) && order.items.length > 0) {
            order.items.forEach(item => addItemRow(item));
        } else {
             addItemRow(); // Añadir un item por defecto si no hay items guardados
        }
        
        // Recalcular y actualizar abono (que viene como número y necesita formato)
        calculateTotals();
        document.getElementById('montoAbonadoInput').value = formatCLP(order.montoAbonado || 0);

        showMessage(`Orden N° ${otId} cargada.`, 'primary');
        closeModal();
        return true;
    }

    async function deleteOrder(otId) {
        // Implementación de confirmación personalizada sin window.confirm/alert
        const customConfirm = (message) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('modalConfirm');
                const msg = document.getElementById('confirmMessage');
                const btnYes = document.getElementById('confirmYes');
                const btnNo = document.getElementById('confirmNo');

                msg.textContent = message;
                modal.classList.remove('hidden');

                const handleYes = () => {
                    modal.classList.add('hidden');
                    btnYes.removeEventListener('click', handleYes);
                    btnNo.removeEventListener('click', handleNo);
                    resolve(true);
                };
                const handleNo = () => {
                    modal.classList.add('hidden');
                    btnYes.removeEventListener('click', handleYes);
                    btnNo.removeEventListener('click', handleNo);
                    resolve(false);
                };

                btnYes.addEventListener('click', handleYes);
                btnNo.addEventListener('click', handleNo);
            });
        };

        const userConfirmed = await customConfirm(`¿Estás seguro de que quieres eliminar la Orden N° ${otId}? Esta acción es permanente.`);

        if (!userConfirmed) return;

        try {
            const docRef = doc(getOrdersCollectionRef(), otId);
            await deleteDoc(docRef);

            showMessage(`Orden N° ${otId} eliminada correctamente.`, 'danger');
            
            if (currentOtId === otId) {
                newOt();
            }

        } catch (error) {
            console.error("Error al eliminar en Firestore:", error);
            showMessage("Error al eliminar la orden: " + error.message, 'danger', 8000);
        }
    }


    // ====================================================================\
    // OT MANAGEMENT & UI
    // ====================================================================\

    function getNewOtNumber() {
        const maxOt = workOrders.reduce((max, order) => {
            const otNum = unformatCLP(order.ot);
            return otNum > max ? otNum : max;
        }, 0);
        // Retorna el máximo + 1 como string, forzando 4 dígitos
        return String(maxOt + 1).padStart(4, '0');
    }

    function updateOtDisplay(otId) {
        document.getElementById('otNumber').value = otId;
        currentOtId = otId;
    }

    function newOt() {
        resetForm(true); 
        updateOtDisplay(getNewOtNumber());
        showMessage("Formulario limpiado. Nueva OT lista.", 'primary');
    }

    function resetForm(addDefaultItem = true) {
        document.getElementById('otForm').reset();
        document.getElementById('itemsContainer').innerHTML = '';
        if (addDefaultItem) {
            addItemRow(); 
        }
        calculateTotals();
        // Resetear el valor visual del N° OT
        document.getElementById('otNumber').value = '0000'; 
    }

    // ====================================================================\
    // ITEM MANAGEMENT (Repuestos/Servicios)
    // ====================================================================\

    function addItemRow(data = {}) {
        const container = document.getElementById('itemsContainer');
        const index = container.children.length;
        
        // Convertir el precio guardado (numérico) a formato CLP para el input
        const formattedPrice = formatCLP(data.price || 0);

        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
            <input name="item_desc_${index}" placeholder="Descripción (Repuesto/Servicio)" value="${data.desc || ''}" class="desc-input" required>
            <input name="item_qty_${index}" placeholder="Qty" type="number" inputmode="numeric" value="${data.qty || '1'}" min="1" required class="qty-input">
            <input name="item_price_${index}" placeholder="Precio Unitario" type="text" inputmode="numeric" value="${formattedPrice}" required class="price-input">
            <span class="total-item">Total: $${formatCLP(data.total || (data.qty || 1) * unformatCLP(data.price || 0))}</span>
            <button type="button" class="delete-item-btn"><i data-lucide="x"></i></button>
        `;
        
        lucide.createIcons();

        // Event listeners para la fila
        const priceInput = row.querySelector(`.price-input`);
        const qtyInput = row.querySelector(`.qty-input`);
        const deleteBtn = row.querySelector('.delete-item-btn');

        priceInput.addEventListener('input', (e) => {
            handleFormatOnInput(e);
            calculateTotals();
        });
        qtyInput.addEventListener('input', calculateTotals);
        deleteBtn.addEventListener('click', () => {
            if (container.children.length > 1) {
                row.remove();
                calculateTotals();
            } else {
                showMessage("Debe haber al menos un item.", 'primary');
            }
        });

        container.appendChild(row);
        calculateTotals();
    }

    function calculateTotals() {
        const container = document.getElementById('itemsContainer');
        let subtotal = 0;
        const itemRows = Array.from(container.querySelectorAll('.item-row'));

        itemRows.forEach(row => {
            const qty = parseInt(row.querySelector('.qty-input').value) || 0;
            const price = unformatCLP(row.querySelector('.price-input').value);
            const itemTotal = qty * price;
            
            row.querySelector('.total-item').textContent = `Total: $${formatCLP(itemTotal)}`;
            subtotal += itemTotal;
        });

        const iva = Math.round(subtotal * 0.19);
        const total = subtotal + iva;

        // Actualizar campos de solo lectura
        document.getElementById('subtotalInput').value = formatCLP(subtotal);
        document.getElementById('ivaInput').value = formatCLP(iva);
        document.getElementById('totalInput').value = formatCLP(total);
    }

    // ====================================================================\
    // FORM SUBMISSION & DATA EXTRACTION
    // ====================================================================\

    function extractFormData() {
        const form = document.getElementById('otForm');
        const formData = {};

        // 1. Campos del formulario
        Array.from(form.elements).forEach(element => {
            if (element.name && element.name.startsWith('item_') === false) {
                if (element.id === 'montoAbonadoInput') {
                    formData[element.name] = unformatCLP(element.value);
                } else if (element.name !== 'subtotal' && element.name !== 'iva' && element.name !== 'total') {
                    formData[element.name] = element.value.trim();
                }
            }
        });

        // 2. Número de OT
        const otNumber = document.getElementById('otNumber').value;
        formData.ot = otNumber;

        // 3. Totales (aseguramos guardar los valores numéricos calculados)
        calculateTotals(); 
        formData.subtotal = unformatCLP(document.getElementById('subtotalInput').value);
        formData.iva = unformatCLP(document.getElementById('ivaInput').value);
        formData.total = unformatCLP(document.getElementById('totalInput').value);

        // 4. Items
        formData.items = [];
        const itemRows = Array.from(document.getElementById('itemsContainer').querySelectorAll('.item-row'));
        
        itemRows.forEach((row) => {
            const descInput = row.querySelector(`.desc-input`);
            const qtyInput = row.querySelector(`.qty-input`);
            const priceInput = row.querySelector(`.price-input`);
            
            const price = unformatCLP(priceInput.value);
            const qty = parseInt(qtyInput.value) || 0;
            
            if (descInput.value.trim()) {
                formData.items.push({
                    desc: descInput.value.trim(),
                    qty: qty,
                    price: price, 
                    total: qty * price
                });
            }
        });
        
        // 5. Metadata
        formData.date = new Date().toISOString().split('T')[0];
        formData.timestamp = Date.now();
        formData.userId = userId;

        return formData;
    }

    function handleSave(e) {
        e.preventDefault();
        const form = document.getElementById('otForm');
        
        // Validación de campos mínimos
        if (!form.nombreCliente.value.trim() || !form.problemaReportado.value.trim() || document.getElementById('itemsContainer').children.length === 0) {
            showMessage("Por favor, complete el Nombre del Cliente, el Problema Reportado y agregue al menos un Item.", 'danger');
            return;
        }
        
        const formData = extractFormData();
        saveOrder(formData);
    }

    // ====================================================================\
    // MODAL & LIST RENDERING
    // ====================================================================\

    function renderOrdersList(orders) {
        const list = document.getElementById('ordersList');
        const searchValue = document.getElementById('searchOt').value.toLowerCase();
        list.innerHTML = '';

        const filteredOrders = orders.filter(order => 
            String(order.ot).includes(searchValue) || 
            (order.nombreCliente && order.nombreCliente.toLowerCase().includes(searchValue))
        );

        if (filteredOrders.length === 0) {
            list.innerHTML = `<p class="text-center p-4">${searchValue ? 'No se encontraron resultados.' : 'No hay órdenes de trabajo guardadas.'}</p>`;
            return;
        }

        filteredOrders.forEach(order => {
            const otId = String(order.ot); 

            const row = document.createElement('div');
            row.className = 'order-row';
            row.innerHTML = `
                <div class="order-info">
                    <b>OT N° ${otId}</b> - ${order.nombreCliente || 'Cliente sin nombre'}
                    <small>${order.date || ''}</small>
                </div>
                <div class="order-actions">
                    <button data-action="load" class="small">Cargar</button>
                    <button data-action="print" class="small accent">Imprimir</button>
                    <button data-action="delete" class="small danger">Eliminar</button>
                </div>
            `;
            
            row.querySelector('[data-action="load"]').addEventListener('click', () => loadOrder(otId));
            row.querySelector('[data-action="print"]').addEventListener('click', () => printOrder(order));
            row.querySelector('[data-action="delete"]').addEventListener('click', () => deleteOrder(otId));

            list.appendChild(row);
        });
    }

    function openModal() {
        document.getElementById('modal').classList.remove('hidden');
        renderOrdersList(workOrders); 
    }

    function closeModal() {
        document.getElementById('modal').classList.add('hidden');
    }

    // ====================================================================\
    // EXCEL EXPORT
    // ====================================================================\

    function exportToExcel() {
        if (workOrders.length === 0) {
            showMessage("No hay órdenes para exportar.", 'primary');
            return;
        }

        const flatData = [];
        
        workOrders.forEach(order => {
            const base = {
                'N° OT': order.ot,
                'Fecha': order.date,
                'Nombre Cliente': order.nombreCliente,
                'Rut/ID': order.rutId,
                'Teléfono': order.telefono,
                'Email': order.email,
                'Tipo Equipo': order.tipoEquipo,
                'Marca/Modelo': order.marcaModelo,
                'N° Serie': order.nroSerie,
                'Problema Reportado': order.problemaReportado,
                'Subtotal (CLP)': unformatCLP(order.subtotal),
                'IVA (CLP)': unformatCLP(order.iva),
                'TOTAL (CLP)': unformatCLP(order.total),
                'Monto Abonado (CLP)': unformatCLP(order.montoAbonado),
            };

            if (order.items && order.items.length > 0) {
                order.items.forEach((item, index) => {
                    // Evitar repetir toda la base en cada fila, simplemente añadir una fila por item
                    flatData.push({
                        ...base,
                        'Item Descripción': item.desc,
                        'Item Cantidad': item.qty,
                        'Item P. Unitario (CLP)': unformatCLP(item.price),
                        'Item Total (CLP)': unformatCLP(item.total),
                    });
                });
            } else {
                // Si no hay ítems, añadir la fila base para no perder la OT
                flatData.push({
                     ...base,
                    'Item Descripción': 'N/A',
                    'Item Cantidad': 0,
                    'Item P. Unitario (CLP)': 0,
                    'Item Total (CLP)': 0,
                }); 
            }
        });

        // Crear una hoja de cálculo a partir de los datos aplanados
        const worksheet = XLSX.utils.json_to_sheet(flatData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "OrdenesDeTrabajo");

        XLSX.writeFile(workbook, "Fueltek_OT_Export.xlsx");
        showMessage("Datos exportados a Excel.", 'success');
    }

    // ====================================================================\
    // PRINTING
    // ====================================================================\

    function printOrder(order) {
        const printArea = document.getElementById('printArea');
        
        const formattedOrder = { ...order };
        // Aseguramos que los valores a imprimir estén formateados a CLP
        ['subtotal', 'iva', 'total', 'montoAbonado'].forEach(key => {
            formattedOrder[key] = formatCLP(order[key]);
        });
        
        if (formattedOrder.items) {
            formattedOrder.items = formattedOrder.items.map(item => ({
                ...item,
                // Los ítems deben mostrarse con precio unitario y total formateado
                price: formatCLP(item.price),
                total: formatCLP(item.total)
            }));
        }

        // Construir el HTML de impresión (debe replicar la estructura de impresión del CSS)
        printArea.innerHTML = `
            <header>
                <img src="https://placehold.co/80x80/2c3e50/ffffff?text=FT" alt="Fueltek Logo" class="logo" />
                <div class="header-info">
                    <h1>FUELTEK</h1>
                    <p>Servicio Técnico Multimarca</p>
                    <small>Tel: +56 9 4043 5805 | La Trilla 1062, San Bernardo</small>
                </div>
            </header>

            <main>
                <div class="ot-bar">
                    <div class="left">
                        <label class="ot-label">N° OT:</label>
                        <span>${formattedOrder.ot}</span>
                    </div>
                    <div class="right">
                        <small>Fecha: ${formattedOrder.date || new Date().toISOString().split('T')[0]}</small>
                    </div>
                </div>

                <fieldset class="grid-2-col">
                    <legend>Datos del Cliente</legend>
                    <label>Nombre Cliente: <span>${formattedOrder.nombreCliente || '-'}</span></label>
                    <label>Rut/ID: <span>${formattedOrder.rutId || '-'}</span></label>
                    <label>Teléfono: <span>${formattedOrder.telefono || '-'}</span></label>
                    <label>Email: <span>${formattedOrder.email || '-'}</span></label>
                </fieldset>

                <fieldset class="grid-2-col">
                    <legend>Datos del Equipo</legend>
                    <label>Tipo Equipo: <span>${formattedOrder.tipoEquipo || '-'}</span></label>
                    <label>Marca/Modelo: <span>${formattedOrder.marcaModelo || '-'}</span></label>
                    <label>Año: <span>${formattedOrder.año || '-'}</span></label>
                    <label>N° Serie/VIN: <span>${formattedOrder.nroSerie || '-'}</span></label>
                </fieldset>

                <fieldset>
                    <legend>Problema Reportado / Trabajos a Realizar</legend>
                    <label>Descripción: <p>${formattedOrder.problemaReportado || '-'}</p></label>
                </fieldset>

                <fieldset class="print-items-table">
                    <legend>Detalle de Repuestos, Servicios y Valores</legend>
                    <table>
                        <thead>
                            <tr>
                                <th>Descripción</th>
                                <th>Qty</th>
                                <th class="right">P. Unitario</th>
                                <th class="right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${formattedOrder.items && formattedOrder.items.length > 0 ? formattedOrder.items.map(item => `
                                <tr>
                                    <td>${item.desc}</td>
                                    <td>${item.qty}</td>
                                    <td class="right">$${item.price}</td>
                                    <td class="right">$${item.total}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="4">Sin detalles.</td></tr>'}
                        </tbody>
                    </table>

                    <div class="total-bar">
                        <label>Subtotal: <span>$${formattedOrder.subtotal}</span></label>
                        <label>IVA (19%): <span>$${formattedOrder.iva}</span></label>
                        <label>TOTAL: <span>$${formattedOrder.total}</span></label>
                    </div>

                    <div class="abono-bar">
                        <label>Monto Abonado: <span>$${formattedOrder.montoAbonado}</span></label>
                    </div>
                </fieldset>

                <div class="firmas">
                    <div class="firma-box"><label>Firma Taller</label><span class="signature-line"></span></div>
                    <div class="firma-box"><label>Firma Cliente</label><span class="signature-line"></span></div>
                </div>

                <section class="notas">
                    <h4>Notas importantes</h4>
                    <ul>
                        <li>Toda herramienta no retirada en 30 días podrá generar cobro por almacenamiento.</li>
                        <li>FuelTek no se responsabiliza por accesorios no declarados al momento de la recepción.</li>
                        <li>El cliente declara estar informado sobre los términos del servicio y autoriza la revisión del equipo.</li>
                    </ul>
                </section>
            </main>
        `;

        window.print();
    }

    // ====================================================================\
    // EVENT LISTENERS
    // ====================================================================\

    function setupEventListeners() {
        // Formato inicial para el monto abonado
        document.getElementById('montoAbonadoInput').value = formatCLP(unformatCLP(document.getElementById('montoAbonadoInput').value));
        
        // Buttons
        document.getElementById('saveOtBtn').addEventListener('click', handleSave);
        document.getElementById('newOtBtn').addEventListener('click', newOt);
        document.getElementById('addItemBtn').addEventListener('click', () => addItemRow());
        document.getElementById('openModalBtn').addEventListener('click', openModal);
        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
        document.getElementById('searchOt').addEventListener('input', () => renderOrdersList(workOrders));
        
        document.getElementById('printOtBtn').addEventListener('click', () => {
            if (!currentOtId) {
                showMessage("Cargue o guarde una OT primero para poder imprimir.", 'primary');
                return;
            }
            const currentOrder = workOrders.find(o => o.ot === currentOtId);
            if (currentOrder) {
                printOrder(currentOrder);
            } else {
                showMessage("No se encontró la OT cargada para imprimir. Guarde la OT actual.", 'danger');
            }
        });

        // Mobile Menu
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            const menu = document.querySelector('.ot-bar .right');
            menu.classList.toggle('mobile-visible');
            const iconName = menu.classList.contains('mobile-visible') ? 'x' : 'menu';
            document.getElementById('mobileMenuBtn').innerHTML = `<i data-lucide="${iconName}"></i>`;
            lucide.createIcons();
        });

        // Delegate listener para los inputs de precio/cantidad
        document.getElementById('otForm').addEventListener('input', (e) => {
            if (e.target.classList.contains('price-input')) {
                handleFormatOnInput(e);
                calculateTotals();
            } else if (e.target.classList.contains('qty-input')) {
                calculateTotals();
            }
        });
        
        // Formato de moneda para monto abonado
        document.getElementById('montoAbonadoInput').addEventListener('input', handleFormatOnInput);

    }

    // Lógica para el modal de confirmación
    function setupConfirmModal() {
        // Inicialización para asegurar que el modal de confirmación esté listo.
        const modal = document.getElementById('modalConfirm');
        if (!modal) {
             console.error("Confirm Modal no encontrado.");
        }
    }
    
    function initializeAppLogic() {
        // 1. Inicializar la UI y los listeners (siempre debe pasar)
        setupConfirmModal();
        addItemRow(); // Añadir el primer item por defecto
        setupEventListeners();

        // 2. Si la autenticación está lista, iniciar el listener de DB
        if (isAuthReady) {
            setupFirestoreListener();
        } else {
             // Si la auth falla o es lenta, al menos cargar una OT nueva
             newOt(); 
             showMessage("Conectando con la base de datos...", 'primary', 0);
        }
        
    }
    
    // Iniciar la secuencia de Firebase y Autenticación
    document.addEventListener('DOMContentLoaded', initializeFirebase);
  </script>
</body>
</html>
