<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orden de Trabajo - Fueltek</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div class="wrapper">
    <header>
      <img src="logo-fueltek.png" alt="Fueltek Logo" class="logo" />
      <div class="header-info">
        <h1>FUELTEK</h1>
        <p>Servicio Técnico Multimarca</p>
        <small>Tel: +56 9 4043 5805 | La Trilla 1062, San Bernardo</small>
      </div>
    </header>

    <main>
      <div class="ot-bar">
        <div class="left">
          <label class="ot-label">N° OT:</label>
          <!-- El número de OT es la clave de Firestore. Lo haremos visible aquí -->
          <input id="otNumber" readonly /> 
        </div>

        <button id="mobileMenuBtn" class="mobile-only" title="Menú"><i data-lucide="menu"></i></button>

        <div class="right desktop-only">
          <button id="newOtBtn"><i data-lucide="plus"></i> Nueva OT</button>
          <button id="saveOtBtn" class="success"><i data-lucide="save"></i> Guardar</button>
          <button id="printOtBtn" class="accent"><i data-lucide="printer"></i> Imprimir</button>
          <button id="openModalBtn" class="primary"><i data-lucide="folder"></i> Ver Órdenes</button>
          <button id="exportExcelBtn" class="primary"><i data-lucide="file-spreadsheet"></i> Exportar Excel</button>
        </div>
      </div>
      
      <!-- Contenedor para mensajes de estado/error -->
      <div id="messageBox" class="message-box hidden" role="alert"></div>

      <!-- Información de la sesión Firebase -->
      <div class="session-info">
        <small id="authStatus"></small>
      </div>

      <form id="otForm">
        <fieldset class="grid-2-col">
          <legend>Datos del Cliente</legend>
          <label>Nombre Cliente: <input name="nombreCliente" required /></label>
          <label>Rut/ID: <input name="rutId" /></label>
          <label>Teléfono: <input name="telefono" type="tel" /></label>
          <label>Email: <input name="email" type="email" /></label>
        </fieldset>

        <fieldset class="grid-2-col">
          <legend>Datos del Equipo</legend>
          <label>Tipo Equipo: <input name="tipoEquipo" /></label>
          <label>Marca/Modelo: <input name="marcaModelo" /></label>
          <label>Año: <input name="año" type="number" inputmode="numeric" /></label>
          <label>N° Serie/VIN: <input name="nroSerie" /></label>
        </fieldset>

        <fieldset>
          <legend>Problema Reportado / Trabajos a Realizar</legend>
          <label>Descripción: <textarea name="problemaReportado" rows="4" required></textarea></label>
        </fieldset>

        <fieldset>
          <legend>Detalle de Repuestos, Servicios y Valores</legend>
          <div id="itemsContainer">
            <!-- Los items se agregarán aquí por JavaScript -->
          </div>
          <button type="button" id="addItemBtn" class="primary small"><i data-lucide="plus"></i> Agregar Item</button>

          <div class="total-bar">
            <label>Subtotal: <input name="subtotal" type="text" inputmode="numeric" id="subtotalInput" readonly /></label>
            <label>IVA (19%): <input name="iva" type="text" inputmode="numeric" id="ivaInput" readonly /></label>
            <label>TOTAL: <input name="total" type="text" inputmode="numeric" id="totalInput" readonly /></label>
          </div>

          <div class="abono-bar">
            <label>Monto Abonado: <input name="montoAbonado" type="text" inputmode="numeric" id="montoAbonadoInput" /></label>
          </div>
        </fieldset>

        <div class="firmas">
          <div class="firma-box"><label>Firma Taller</label><input name="firmaTaller" /></div>
          <div class="firma-box"><label>Firma Cliente</label><input name="firmaCliente" /></div>
        </div>

        <section class="notas">
          <h4>Notas importantes</h4>
          <ul>
            <li>Toda herramienta no retirada en 30 días podrá generar cobro por almacenamiento.</li>
            <li>FuelTek no se responsabiliza por accesorios no declarados al momento de la recepción.</li>
            <li>El cliente declara estar informado sobre los términos del servicio y autoriza la revisión del equipo.</li>
          </ul>
        </section>
      </form>
    </main>

    <footer>
      <p>© 2025 FUELTEK</p>
    </footer>
  </div>

  <div id="modal" class="modal hidden" role="dialog" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Órdenes guardadas</h3>
        <button id="closeModal" class="small">Cerrar</button>
      </div>
      <div class="modal-body">
        <input id="searchOt" placeholder="Buscar por N° OT o nombre cliente..." />
        <div id="ordersList" class="orders-list"></div>
        <p class="mt-4"><small>Los datos se guardan en Firebase Firestore bajo tu ID de usuario.</small></p>
      </div>
    </div>
  </div>

  <div id="printArea" class="print-area" style="display:none"></div>

  <!-- Importaciones de Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, setDoc, deleteDoc, query, onSnapshot, getDocs, orderBy, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Mantenemos la configuración que el usuario proporcionó como referencia,
    // pero el entorno inyecta la configuración real en __firebase_config
    /*
    const USER_CONFIG = {
        apiKey: "AIzaSyATGBP6B5YoOk8kkovZydhQ9rLjjmxwgds",
        authDomain: "ot-fueltek.firebaseapp.com",
        projectId: "ot-fueltek",
        storageBucket: "ot-fueltek.firebasestorage.app",
        messagingSenderId: "884528621368",
        appId: "1:884528621368:web:d82923bef09c48ad3b83cd",
        measurementId: "G-DCNFDEJN0Y"
    };
    */
    
    // VARIABLES GLOBALES DEL ENTORNO
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;

    // Inicialización y Autenticación
    if (Object.keys(firebaseConfig).length > 0) {
      setLogLevel('debug'); // Para ver logs de Firebase
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
    } else {
      console.error("Firebase config is missing.");
    }

    // Exportar variables y funciones necesarias al ámbito global (window)
    window.firebase = { db, auth, appId, setDoc, doc, collection, deleteDoc, query, onSnapshot, getDocs, getDoc, where };
    
    // Autenticación
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
            document.getElementById('authStatus').textContent = `ID de Usuario: ${userId.substring(0, 8)}... (Autenticado)`;
        } else {
            // Si la autenticación falla o no hay usuario, intentar de forma anónima
            try {
                // Generar un ID aleatorio para usuarios no autenticados (opcional, pero útil para datos privados)
                userId = crypto.randomUUID(); 
                await signInAnonymously(auth);
                document.getElementById('authStatus').textContent = `ID de Usuario: ${userId.substring(0, 8)}... (Anónimo)`;
            } catch (error) {
                console.error("Error en autenticación anónima:", error);
                document.getElementById('authStatus').textContent = "ERROR de autenticación";
            }
        }
        isAuthReady = true;
        
        // Cargar script.js y comenzar la lógica de la aplicación SOLO cuando la autenticación esté lista
        const script = document.createElement('script');
        script.src = 'script.js';
        script.setAttribute('type', 'module'); // Se mantiene como módulo para la lógica del script
        document.body.appendChild(script);
    });

    // Intento de inicio de sesión con token personalizado (si está disponible)
    if (auth && initialAuthToken) {
        setPersistence(auth, browserSessionPersistence).then(() => {
             signInWithCustomToken(auth, initialAuthToken).catch((error) => {
                console.error("Error al iniciar sesión con Custom Token:", error);
             });
        });
    }

  </script>
</body>
</html>
